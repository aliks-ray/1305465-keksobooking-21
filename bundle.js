(()=>{"use strict";window.util={getNoun:function(e,t,o,n){let r=Math.abs(e);return r%=100,r>=5&&r<=20?n:(r%=10,1===r?t:r>=2&&r<=4?o:n)},debounce:function(e){let t=!1;return function(o){t&&clearTimeout(t),t=setTimeout(e.bind(null,o),500)}}},(()=>{const e=(e,t,o,n)=>{const r=new XMLHttpRequest;return r.responseType="json",r.addEventListener("load",(()=>{switch(r.status){case 200:o(r.response);break;default:n("Ошибка соединения. Статус ответа: "+r.status+" "+r.statusText)}})),r.addEventListener("error",(()=>{n("Ошибка соединения")})),r.addEventListener("timeout",(()=>{n("Запрос не успел выполниться за "+r.timeout+"мс.")})),r.timeout=2e4,r.open(e,t),r};window.backend={load:(t,o)=>{e("GET","https://21.javascript.pages.academy/keksobooking/data",t,o).send()},save:(t,o,n)=>{e("POST","https://21.javascript.pages.academy/keksobooking",o,n).send(t)},onError:e=>{const t=document.createElement("div");t.classList.add("error__upload"),t.textContent=e,document.body.insertAdjacentElement("afterbegin",t),setTimeout((()=>{t.remove()}),5e3)}}})(),(()=>{let e=[];const t="any",o=document.querySelector(".map__filters"),n=o.querySelector("#housing-type"),r=o.querySelector("#housing-price"),i=o.querySelector("#housing-rooms"),a=o.querySelector("#housing-guests"),d=1e4,s=5e4,c=1e4,l=5e4,u=e=>{const o=n.value;let r=!1;return e.offer.type!==o&&o!==t||(r=!0),r},m=e=>{let o=!1;switch(r.value){case t:o=!0;break;case"middle":e.offer.price>=d&&e.offer.price<=s&&(o=!0);break;case"low":e.offer.price<c&&(o=!0);break;case"high":e.offer.price>l&&(o=!0)}return o},p=e=>{const o=i.value;let n=!1;return e.offer.rooms!==parseInt(o,10)&&o!==t||(n=!0),n},v=e=>{const o=a.value;let n=!1;return e.offer.guests!==parseInt(o,10)&&o!==t||(n=!0),n},w=e=>Array.from(o.querySelectorAll(".map__checkbox:checked")).every((t=>e.offer.features.includes(t.value))),f=e=>{const t=[];for(let o=0;o<e.length&&t.length<5;o++)u(e[o])&&m(e[o])&&p(e[o])&&v(e[o])&&w(e[o])&&t.push(e[o]);return t};o.addEventListener("change",window.util.debounce((()=>{window.pin.addPins(f(e))}))),window.filter={onDataLoad:t=>{e=t;const o=f(e);window.pin.addPins(o,window.pin.PINS_MAX)}}})(),window.data={offerTypes:{palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"}},(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector("#address"),o=e.style.left,n=e.style.top,r={top:Math.floor(46),bottom:Math.floor(546),left:Math.floor(-31),right:Math.floor(1169)},i=o=>{t.value=Math.floor(parseInt(e.style.left,10)+31)+", "+Math.floor(parseInt(e.style.top,10)+o)};var a;i(),a=e,e.addEventListener("mousedown",(e=>{e.preventDefault();let t={x:e.clientX,y:e.clientY};const o=e=>{e.preventDefault();let o=t.x-e.clientX,n=t.y-e.clientY;t={x:e.clientX,y:e.clientY};let d=a.style.top=a.offsetTop-n,s=a.style.left=a.offsetLeft-o;d>=r.bottom?d=r.bottom:d<=r.top&&(d=r.top),s<=r.left?s=r.left:s>r.right&&(s=r.right),a.style.top=d+"px",a.style.left=s+"px",i(84)},n=e=>{e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",n)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",n)})),window.move={setAddress:i,mainPin:e,pinHeightDisable:31,ACTIVE_PIN_HEIGHT:84,getDefaultPinPosition:()=>{e.style.left=o,e.style.top=n}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins"),o=()=>{let e=document.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")};window.pin={addPins:n=>{window.pin.cardRemover(),window.pin.pinsRemover();const r=document.createDocumentFragment();n.forEach((t=>{r.appendChild((t=>{const n=e.cloneNode(!0);return n.style.left=t.location.x-25+"px",n.style.top=t.location.y-70+"px",n.querySelector("img").src=t.author.avatar,n.querySelector("img").alt=t.offer.title,n.addEventListener("click",(()=>{o(),n.classList.add("map__pin--active"),window.card.create(t)})),n.addEventListener("keydown",(e=>{"Enter"===e.key&&window.card.create(t)})),n})(t))})),t.appendChild(r)},removeClassActivePin:o,pinsRemover:()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>e.remove()))},cardRemover:()=>{document.querySelector(".map__card")&&window.card.remove()},PINS_MAX:5}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=document.querySelector(".map__filters-container");let o;const n=()=>{o&&o.remove()};window.card={create:r=>{n(),o=e.cloneNode(!0);const i=o.querySelector(".popup__features"),a=o.querySelector(".popup__photos"),d=o.querySelector(".popup__close"),s=o.querySelector(".popup__title"),c=o.querySelector(".popup__text--address"),l=o.querySelector(".popup__text--price"),u=o.querySelector(".popup__type"),m=o.querySelector(".popup__text--capacity"),p=o.querySelector(".popup__text--time"),v=o.querySelector(".popup__description"),w=o.querySelector(".popup__avatar");for(s.textContent=r.offer.title,c.textContent=r.offer.address,l.textContent=r.offer.price+" ₽/ночь",u.textContent=window.data.offerTypes[r.offer.type],m.textContent=`${r.offer.rooms}\n    ${window.util.getNoun(r.offer.rooms,"комната","комнаты","комнат")}\n    ${r.offer.guests>0?`для ${r.offer.guests}\n    ${window.util.getNoun(r.offer.guests,"гостя","гостей","гостей")}`:"не для гостей"}`,p.textContent=`Заезд после ${r.offer.checkin},\n    выезд до ${r.offer.checkout}`,v.textContent=r.offer.description,w.setAttribute("src",""+r.author.avatar);i.firstChild;)i.removeChild(i.firstChild);for(let e=0;e<r.offer.features.length;e++)i.appendChild(document.createElement("li")).classList.add("popup__feature","popup__feature--"+r.offer.features[e]);for(;a.firstChild;)a.removeChild(a.firstChild);for(let e=0;e<r.offer.photos.length;e++){const t=document.createElement("img");t.src=""+r.offer.photos[e],t.alt="Фото квартиры",t.width=45,t.height=40,a.appendChild(t).classList.add("popup__photo")}const f=()=>{n(),window.pin.removeClassActivePin(),d.removeEventListener("click",f),document.removeEventListener("keydown",y)},y=e=>{"Escape"===e.key&&(n(),window.pin.removeClassActivePin()),d.removeEventListener("click",f),document.removeEventListener("keydown",y)};d.addEventListener("click",f),d.addEventListener("keydown",(e=>{"Enter"===e.key&&(n(),window.pin.removeClassActivePin())})),document.addEventListener("keydown",y),window.main.map.insertBefore(o,t)},remove:n}})(),(()=>{const e={1:[1],2:[1,2],3:[1,2,3],100:[0]},t={flat:"1000",bungalow:"0",house:"5000",palace:"10000"},o=document.querySelector(".ad-form"),n=o.querySelector("#room_number"),r=o.querySelector("#capacity"),i=o.querySelector("#price"),a=o.querySelector("#type"),d=o.querySelector("#timein"),s=o.querySelector("#timeout"),c=()=>{const e=t[a.options[a.selectedIndex].value];i.placeholder=e,i.setAttribute("min",e)},l=()=>{const t=-1===e[n.value].indexOf(+r.value)?"Столько гостей не сможет разместиться, предложите больше комнат":"";r.setCustomValidity(t)},u=t=>{r.querySelectorAll("option").forEach((function(e){e.disabled=!0})),e[t].forEach((e=>{r.querySelector(`option[value="${e}"]`).disabled=!1,r.value=e}))};d.addEventListener("change",(()=>{s.value=d.value})),s.addEventListener("change",(()=>{d.value=s.value})),n.addEventListener("change",(e=>{e.target.setCustomValidity(""),u(n.value),l()})),a.addEventListener("change",(e=>{e.target.setCustomValidity(""),c(i.value),l()})),window.validation={mainForm:o,checkFormValidity:()=>{u(n.value),u(r.value),c()}}})(),(()=>{const e=document.getElementsByTagName("fieldset"),t=document.querySelector("#success").content.querySelector(".success"),o=document.querySelector(".ad-form__reset"),n=()=>{document.body.appendChild((()=>{const e=t.cloneNode(!0),o=t=>{"Escape"===t.key&&e.remove(),document.removeEventListener("keydown",o),document.removeEventListener("click",n)},n=()=>{e.remove(),document.removeEventListener("click",n),document.removeEventListener("keydown",o)};return document.addEventListener("keydown",o),document.addEventListener("click",n),e})()),window.validation.mainForm.reset(),window.validation.checkFormValidity(),window.move.setAddress(window.move.pinHeightDisable)},r=()=>{const e=document.querySelector("#error").content.querySelector(".error");document.body.appendChild((()=>{const t=e.cloneNode(!0),o=t.querySelector(".error__button"),n=e=>{"Escape"===e.key&&t.remove(),document.removeEventListener("keydown",n),document.removeEventListener("click",r)},r=()=>{t.remove(),document.removeEventListener("click",r),document.removeEventListener("keydown",n)};return o.addEventListener("click",r),document.addEventListener("click",r),document.addEventListener("keydown",n),t})())};window.validation.mainForm.addEventListener("submit",(e=>{e.preventDefault(),window.backend.save(new FormData(window.validation.mainForm),n,r),window.validation.mainForm.reset(),window.main.disactivatePage()})),o.addEventListener("click",(()=>{window.validation.mainForm.reset(),window.validation.checkFormValidity(),window.main.disactivatePage()})),window.form={turnOff:()=>{for(let t=0;t<e.length;t++)e[t].disabled=!0},turnOn:()=>{for(let t=0;t<e.length;t++)e[t].disabled=!1}}})(),(()=>{const e=document.querySelector(".map"),t=e=>{0===e.button&&r()},o=e=>{"Enter"===e.key&&r()},n=()=>{window.pin.pinsRemover(),window.pin.cardRemover(),e.classList.add("map--faded"),window.validation.mainForm.classList.add("ad-form--disabled"),window.move.getDefaultPinPosition(),window.move.setAddress(window.move.pinHeightDisable),window.form.turnOff(),window.move.mainPin.addEventListener("mousedown",t),window.move.mainPin.addEventListener("keydown",o)},r=()=>{window.validation.mainForm.classList.remove("ad-form--disabled"),e.classList.remove("map--faded"),window.form.turnOn(),window.move.setAddress(window.move.ACTIVE_PIN_HEIGHT),window.backend.load(window.filter.onDataLoad,window.backend.onError),window.validation.checkFormValidity(),window.move.mainPin.removeEventListener("mousedown",t),window.move.mainPin.removeEventListener("keydown",o)};n(),window.main={map:e,disactivatePage:n}})()})();